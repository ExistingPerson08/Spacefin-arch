---
name: Build disk images

on:
  workflow_dispatch:
    inputs:
      upload-to-s3:
        description: "Upload to S3"
        required: false
        default: false
        type: boolean
      platform:
        required: true
        type: choice
        options:
          - amd64
          - arm64
      edition:
        required: true
        type: choice
        options:
          - cosmic
          - gnome
          - niri
          - kde
  pull_request:
    branches:
      - main
    paths:
      - "./disk_config/disk.toml"
      - "./disk_config/iso.toml"
      - "./.github/workflows/build-disk.yml"

env:
  IMAGE_NAME: "spacefin-${{ inputs.edition }}"
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}" # do not edit
  DEFAULT_TAG: "latest"
  BIB_IMAGE: "ghcr.io/lorbuschris/bootc-image-builder:20250608" # "quay.io/centos-bootc/bootc-image-builder:latest" - see https://github.com/osbuild/bootc-image-builder/pull/954

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  build-iso:
    name: Build ISO
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: read

    steps:
      - name: Maximize build space
        uses: ublue-os/remove-unwanted-software@v9

      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Build ISO
        id: build
        uses: ublue-os/titanoboa@main
        with:
          image-ref: ghcr.io/existingperson08/spacefin-${{ inputs.edition }}:latest
          flatpaks-list: ${{ github.workspace }}/flatpaks/system-flatpaks.list
          hook-post-rootfs: ${{ github.workspace }}/iso_files/configure_iso_anaconda.sh
          compression: squashfs
          builder-distro: fedora

      - name: Rename ISO
        run: |
          mkdir -p output
          mv ${{ steps.build.outputs.iso-dest }} output/spacefin-${{ inputs.edition }}-$(date +%Y%m%d).iso
          (cd output && sha256sum *.iso | tee CHECKSUMS)

      - name: Upload ISO
        uses: actions/upload-artifact@v6
        with:
          name: custom-iso
          path: output/
